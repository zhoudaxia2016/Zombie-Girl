<html>
  <head>
    <meta charset="utf-8">
    <title>Threejs and Blender Game Design</title>
    <style>
      * { margin: 0 }
      canvas { width: 100%; height: 100% }

      .front-sight {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 50px;
        height: 50px;
        border: 2px solid #aaf;
        border-radius: 50%;
        transform: translate(-50%, -50%);
      }
    </style>
    <script src="https://cdn.bootcss.com/three.js/90/three.js"></script>
    <script src="https://cdn.bootcss.com/stats.js/r17/Stats.js"></script>
    <script src="src/lib/Sky.js"></script>
    <script src="src/constants.js"></script>
    <script src="src/utils.js"></script>
    <script src="src/skybox.js"></script>
    <script src="src/object.js"></script>
    <script src="src/hitDetect.js"></script>
  </head>

  <body>
    <div class="front-sight"></div>
    <script>
let scene, renderer, camera, container
let qtree
let bullets = []

// Show fps
let stats = new Stats()
document.body.appendChild(stats.dom)

init()

// 导入role
let role = new Person(FILES.ROLE, ROLE.INITIAL_SPEED, ROLE.MOVE_DURATION, ROLE.FAST_SPEED)
let roleLoadPromise = role.load()

let zombies = []
let zombieLoadPromises = []
for (let i = 0; i <  1; i ++) {
  let zombie = new Zombie(FILES.ZOMBIE)
  let promise = zombie.load(role.listener, FILES.ZOMBIE_SOUND)
  zombies.push(zombie)
  zombieLoadPromises.push(promise)
}


// 导入land和surrounddings
let surrounddings = [], land = {}, cloneLand = {}
let surrounddingLoadPromise = Surroundding.load(FILES.SURROUNDDING)
let loadPromise = Promise.all([roleLoadPromise, surrounddingLoadPromise])

loadPromise.then(function () {
  role.setCamera(camera)
  qtree = createQuadTree()
  let { left, right, top, bottom } = land.rect
  for (let i = 0; i < zombies.length; i ++) {
    let x = right + (left - right) * Math.random()
    let z = bottom + (top - bottom) * Math.random()
    zombies[i].model.position.set(x, 0, z)
  }

  let model = land.model
  land.vertices = model.geometry.vertices.map(item => item.clone().applyMatrix4(model.matrixWorld))
  animate()
})

function init () {
  container = document.createElement('div')
  document.body.appendChild(container)

  // scene
  scene = new THREE.Scene()

  // camera
  camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 1000 );

  // light
  scene.add( new THREE.AmbientLight( 0xffffff ) );
  directionalLight = new THREE.DirectionalLight( 0xffffff, 0.5 );
  directionalLight.position.set( 0, 100, 0 );
  directionalLight.castShadow = true
  scene.add( directionalLight );

  createSkyBox(scene)

  // renderer
  renderer = new THREE.WebGLRenderer()
  renderer.shadowMapEnabled = true;
  renderer.setPixelRatio(window.devicePixelRatio)
  renderer.setSize(window.innerWidth, window.innerHeight)
  renderer.setClearColor(0xaaaaaa)

  container.appendChild(renderer.domElement)
  window.addEventListener( 'resize', onWindowResize, false)
}

function animate () {
  requestAnimationFrame(animate)

  if (!fall.surroundding_fall) {
    fall(land, surrounddings)
    fall.surroundding_fall = true
  }

  if (!fall.zombie_fall) {
    fall(land, zombies)
    fall.zombie_fall = true
  }

  role.update()
  for (let zombie of zombies) {
    zombie.update(role)
  }
  for (let bullet of bullets) {
    bullet.update()

  }
  hitDetect(qtree)

  render()
  stats.update()
}

function render() {
  renderer.render(scene, camera)
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize( window.innerWidth, window.innerHeight )
  render()
}
    </script>
  </body>
</html>
