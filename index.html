<html>
  <head>
    <meta charset="utf-8">
    <title>Threejs and Blender Game Design</title>
    <style>
      * { margin: 0 }
      canvas { width: 100%; height: 100% }
    </style>
    <script src="https://cdn.bootcss.com/three.js/90/three.min.js"></script>
    <script src="lib/collada-loader.js"></script>
    <script src="move.js"></script>
    <script src="hitDetect.js"></script>
    <script src="newLoadPromise.js"></script>
    <script src="model.js"></script>
    <script src="animate.js"></script>
  </head>

  <body>
    <script>
let scene, renderer, camera, container
let mixer, action
let clock = new THREE.Clock(true)

init()

// 导入boy
let loadBoy = newLoadPromise(models.boy.url, THREE.JSONLoader)
loadBoy.then(function ([geometry, materials]) {
  for ( var k in materials ) {
    materials[k].skinning = true
  }
  let skinnedMesh = new THREE.SkinnedMesh(geometry, new THREE.MeshFaceMaterial(materials));
  scene.add(skinnedMesh);
  console.log('a',skinnedMesh.geometry.animations)

  mixer = new THREE.AnimationMixer(skinnedMesh)
  action = mixer.clipAction('walk')
  action = mixer.clipAction(skinnedMesh.geometry.animations[0])
  models.boy.obj = skinnedMesh
  models.boy.obj.add(camera)
  camera.position.set(0, 3, -3)
  camera.lookAt(0, 1.5, 0)
})
/*
let loadBoy = newLoadPromise(models.boy.url, THREE.ColladaLoader)
loadBoy.then(function (collada) {
  let animations = collada.animations;
  models.boy.obj = collada.scene
  mixer = new THREE.AnimationMixer( models.boy.obj );
  action = mixer.clipAction(animations[0])
  models.boy.obj.position.set(0, 0, 0)
  scene.add(models.boy.obj)
  models.boy.obj.add(camera)
  camera.position.set(0, 5, 3.5)
  camera.lookAt(0, 0, 2)
  camera.rotateZ(Math.PI)
})
*/

// 导入land
let loadLand = newLoadPromise(models.land.url, THREE.ColladaLoader)
loadLand.then(function (collada) {
  console.log('Land loading finished!')
  collada.scene.traverse(function (child) {
    if (child.name === models.land.name) {
      let land = models.land
      land.obj = child
      land.obj.position.set(0, 0, 0)
    }
    for (let key in nature_group) {
      let group = nature_group[key]
      if (child.name.startsWith(group.name)) {
        group.objs.push(child)
      }
    }
  })
  scene.add(collada.scene)
})

let loading = Promise.all([loadBoy, loadLand])
loading.then(function () {
  console.log('Finish loading model!')
  // 解决物体漂浮在地面上的问题，不过计算量太大，还是直接在blender里修改
  /*
  for (let value of Object.values(nature_group)) {
    for (let obj of value.objs) {
      let vector = groundHitDetect(obj, models.land.obj)
      let position = obj.position
      let a = 0
      while (vector.x !== 0 || vector.y !== 0 || vector.z !== 0) {
        position.add(vector)
        vector = groundHitDetect(obj, models.land.obj)
        if (a == 100) {
          break
        }
      }
    }
  }
  */
  animate()
})


function init () {
  container = document.createElement('div')
  document.body.appendChild(container)

  // scene
  scene = new THREE.Scene()

  // camera
  camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 1000 );
  camera.position.set( -10, 10, 20 );

  // light
  scene.add( new THREE.AmbientLight( 0xffffff ) );
  directionalLight = new THREE.DirectionalLight( 0xffffff, 0.5 );
  directionalLight.position.set( 10, 10, 10 );
  scene.add( directionalLight );

  // renderer
  renderer = new THREE.WebGLRenderer()
  renderer.setPixelRatio( window.devicePixelRatio );
  renderer.setSize( window.innerWidth, window.innerHeight );
  renderer.setClearColor( 0xaaaaaa )

  container.appendChild( renderer.domElement );
}

function animate() {
  requestAnimationFrame( animate );
  if (mixer) {
    if (forward) {
      action.play()
      mixer.update(clock.getDelta())
      models.boy.obj.translateZ(speed)
    } else {
      action.stop()
    }
  }
  if (turnLeft) {
    models.boy.obj.rotateY(Math.PI/100)
  }
  if (turnRight) {
    models.boy.obj.rotateY(-Math.PI/100)
  }
  //let position = models.boy.obj.position
  //position.add(groundHitDetect(models.boy.obj, models.land.obj))
  //groundHitDetect(models.boy.obj, models.land.obj)
  render();
}

function render() {
  renderer.render( scene, camera );
}
    </script>
  </body>
</html>
