<html>
  <head>
    <meta charset="utf-8">
    <title>Threejs and Blender Game Design</title>
    <style>
      * { margin: 0 }
      canvas { width: 100%; height: 100% }
    </style>
    <script src="https://cdn.bootcss.com/three.js/90/three.min.js"></script>
    <script src="lib/collada-loader.js"></script>
    <script src="move.js"></script>
    <script src="hitDetect.js"></script>
    <script src="newLoadPromise.js"></script>
    <script src="model.js"></script>
  </head>

  <body>
    <script>
let scene, renderer, camera, container
let mixer, action
let clock = new THREE.Clock(true)

init()

// 导入boy
let loadBoy = newLoadPromise(models.boy.url, THREE.ColladaLoader)
loadBoy.then(function (collada) {
  let animations = collada.animations;
  models.boy.obj = collada.scene
  mixer = new THREE.AnimationMixer( models.boy.obj );
  action = mixer.clipAction(animations[0])
  models.boy.obj.position.set(0, 0, 0)
  scene.add(models.boy.obj)
  models.boy.obj.add(camera)
  camera.position.set(0, 5, 3.5)
  camera.lookAt(0, 0, 2)
  camera.rotateZ(Math.PI)
})

// 导入land
let loadLand = newLoadPromise(models.land.url, THREE.ColladaLoader)
loadLand.then(function (collada) {
  console.log('Land loading finished!')
  collada.scene.traverse(function (child) {
    if (child.name === models.land.name) {
      let land = models.land
      land.obj = child
      land.obj.position.set(0, 0, 0)
      //scene.add(land.obj)
    }
    for (let key in nature_group) {
      let group = nature_group[key]
      if (child.name.startsWith(group.name)) {
        group.objs.push(child)
        //scene.add(child)
      }
    }
  })
  scene.add(collada.scene)
})

let loading = Promise.all([loadBoy, loadLand])
loading.then(function () {
  console.log('Finish loading model!')
  animate()
})


function init () {
  container = document.createElement('div')
  document.body.appendChild(container)

  // scene
  scene = new THREE.Scene()

  // camera
  camera = new THREE.PerspectiveCamera( 30, window.innerWidth / window.innerHeight, 1, 1000 );
  camera.position.set( -10, 10, 20 );

  // light
  scene.add( new THREE.AmbientLight( 0xffffff ) );
  directionalLight = new THREE.DirectionalLight( 0xffffff, 0.5 );
  directionalLight.position.set( 10, 10, 10 );
  scene.add( directionalLight );

  // renderer
  renderer = new THREE.WebGLRenderer()
  renderer.setPixelRatio( window.devicePixelRatio );
  renderer.setSize( window.innerWidth, window.innerHeight );
  renderer.setClearColor( 0xaaaaaa )

  container.appendChild( renderer.domElement );
}

function animate() {
  requestAnimationFrame( animate );
  if (mixer) {
    if (forward) {
      action.play()
      mixer.update(clock.getDelta())
      models.boy.obj.translateY(-speed)
    } else {
      action.stop()
    }
  }
  if (turnLeft) {
    models.boy.obj.rotateZ(Math.PI/100)
  }
  if (turnRight) {
    models.boy.obj.rotateZ(-Math.PI/100)
  }
  let position = models.boy.obj.position
  position.addVectors(position, groundHitDetect(models.boy.obj, models.land.obj))
  //groundHitDetect(models.boy.obj, models.land.obj)
  render();
}

function render() {
  renderer.render( scene, camera );
}
    </script>
  </body>
</html>
