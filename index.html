<html>
  <head>
    <meta charset="utf-8">
    <title>Threejs and Blender Game Design</title>
    <style>
      * { margin: 0 }
      canvas { width: 100%; height: 100% }
    </style>
    <script src="https://cdn.bootcss.com/three.js/90/three.min.js"></script>
    <script src="https://cdn.bootcss.com/stats.js/r17/Stats.js"></script>
    <script src="lib/collada-loader.js"></script>
    <script src="utils.js"></script>
    <script src="object.js"></script>
    <script src="hitDetect.js"></script>
  </head>

  <body>
    <script>
let scene, renderer, camera, container
let clock = new THREE.Clock(true)
let qtree
let frame = []

let stats = new Stats();
document.body.appendChild(stats.dom);

init()

// 导入role
let role = new Person('./model/boy.json', 0.02, 1.6, 0.04)
let roleLoadPromise = role.load()

let zombies = []
let zombieLoadPromises = []
for (let i = 0; i <  10; i ++) {
  let zombie = new Zombie('./model/girlZombie.json')
  let promise = zombie.load()
  zombies.push(zombie)
  zombieLoadPromises.push(promise)
}


// 导入land和surrounddings
let surrounddings = [], land = {}, cloneLand = {}
let surrounddingLoadPromise = Surroundding.load('./model/land.json')
let loadPromise = Promise.all([roleLoadPromise, surrounddingLoadPromise])

loadPromise.then(function () {
  role.setCamera(camera)
  qtree = createQuadTree()
  let { left, right, top, bottom } = land.rect
  for (let i = 0; i < zombies.length; i ++) {
    let x = right + (left - right) * Math.random()
    let z = bottom + (top - bottom) * Math.random()
    zombies[i].model.position.set(x, 0, z)
  }

  let model = land.model
  land.vertices = model.geometry.vertices.map(item => item.clone().applyMatrix4(model.matrixWorld))
  animate()
})

function init () {
  container = document.createElement('div')
  document.body.appendChild(container)

  // scene
  scene = new THREE.Scene()

  // camera
  camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 1000 );

  // light
  scene.add( new THREE.AmbientLight( 0xffffff ) );
  directionalLight = new THREE.DirectionalLight( 0xffffff, 0.5 );
  directionalLight.position.set( 0, 100, 0 );
  directionalLight.castShadow = true
  scene.add( directionalLight );

  // renderer
  renderer = new THREE.WebGLRenderer()
  renderer.shadowMapEnabled = true;
  renderer.setPixelRatio( window.devicePixelRatio );
  renderer.setSize( window.innerWidth, window.innerHeight );
  renderer.setClearColor( 0xaaaaaa )

  container.appendChild( renderer.domElement );
}

function animate () {
  requestAnimationFrame(animate)

  role.updateRect()
  role.move()
  role.groundHitDetect(land)

  /*
  if (!Surroundding.fall.done) {
    Surroundding.fall.done = true
    Surroundding.fall(surrounddings)
  }
  */
  if (!Zombie.fall.done) {
    Zombie.fall.done = true
    Zombie.fall(zombies)
  }
  for (let zombie of zombies) {
    zombie.move()
    zombie.updateRect()
    //zombie.groundHitDetect(land)
  }

  hitDetect(qtree)

  render()
  stats.update()
}

function render() {
  renderer.render(scene, camera)
}
    </script>
  </body>
</html>
